<div class="flex flex-col h-full bg-gray-50 relative">

    <!-- Top Bar -->
    <div
        class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-20 flex-shrink-0">
        <button (click)="goBack()"
            class="flex items-center text-gray-500 hover:text-gray-900 font-medium transition-colors">
            <span class="mr-2 text-xl">‚Üê</span> Back
        </button>
        <h1 class="font-bold text-gray-800">Review Prediction</h1>
        <div class="flex items-center space-x-2 text-xs text-gray-400">
            <span class="border px-2 py-1 rounded bg-gray-50">‚Üê Reject</span>
            <span class="border px-2 py-1 rounded bg-gray-50">‚Üí Accept</span>
        </div>
    </div>

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto p-6">
        <div class="max-w-4xl mx-auto space-y-6">

            <!-- Toolbar -->
            <div class="flex items-center justify-center space-x-4 mb-2">
                <button (click)="setMode('review')" [class.bg-blue-600]="interactionMode === 'review'"
                    [class.text-white]="interactionMode === 'review'"
                    class="px-4 py-2 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                    <span>üëÜ Review</span>
                </button>
                <div class="h-8 w-px bg-gray-300"></div>
                <button (click)="setMode('box')" [class.bg-blue-600]="interactionMode === 'box'"
                    [class.text-white]="interactionMode === 'box'"
                    class="px-4 py-2 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                    <span>‚¨ú Draw Box</span>
                </button>
                <button (click)="setMode('poly')" [class.bg-blue-600]="interactionMode === 'poly'"
                    [class.text-white]="interactionMode === 'poly'"
                    class="px-4 py-2 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                    <span>‚úèÔ∏è Draw Poly</span>
                </button>
                <div class="text-xs text-gray-500 ml-4 font-mono">
                    <span *ngIf="interactionMode === 'poly'">Click to add points. Double-click/Enter to close.</span>
                    <span *ngIf="interactionMode === 'box'">Click and drag to draw.</span>
                </div>
            </div>

            <!-- Canvas Container -->
            <div
                class="relative bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden text-center p-4 select-none">
                <canvas #canvas (mousedown)="onMouseDown($event)" (mousemove)="onMouseMove($event)"
                    (mouseup)="onMouseUp($event)" (click)="onCanvasClick($event)" (dblclick)="onCanvasDblClick($event)"
                    class="max-w-full h-auto mx-auto rounded-lg shadow-inner bg-gray-100 cursor-crosshair"></canvas>
                <div *ngIf="!prediction && !current" class="p-10 text-gray-400 italic">No image loaded</div>
            </div>

            <!-- Correction Panel -->
            <div *ngIf="prediction && prediction.detections.length > 0"
                class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 animate-fade-in-up">

                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Detections ({{
                        prediction.detections.length }})</h3>
                    <div class="space-x-4 flex items-center">
                        <label class="flex items-center space-x-2 cursor-pointer group">
                            <input type="checkbox" (change)="markAll($any($event.target).checked)"
                                class="w-4 h-4 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer">
                            <span class="text-xs font-bold text-gray-600 group-hover:text-green-700">Select All</span>
                        </label>

                        <div class="h-4 w-px bg-gray-300"></div>

                        <button (click)="markAll(true)" class="text-xs text-green-600 font-bold hover:underline">Mark
                            All Correct</button>
                    </div>
                </div>

                <div class="space-y-3">
                    <div *ngFor="let det of prediction.detections; let i = index"
                        class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-blue-200 transition-colors"
                        [class.opacity-50]="det['ignore']">

                        <div class="flex items-center space-x-3">
                            <input type="checkbox" [checked]="!det['ignore']" (change)="toggleIgnore(det)"
                                class="w-5 h-5 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer">

                            <span
                                class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">{{
                                i + 1 }}</span>

                            <!-- Poly Icon -->
                            <!-- Poly Icon -->
                            <span *ngIf="det.poly"
                                class="text-[10px] bg-purple-100 text-purple-600 px-1 rounded">POLY</span>

                            <div>
                                <p class="text-[10px] text-gray-400 uppercase font-mono">Confidence: {{ (det.confidence
                                    * 100).toFixed(0) }}%</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3">
                            <!-- Class Selector -->
                            <div class="flex items-center space-x-2" [class.opacity-50]="det['ignore']">
                                <label class="text-xs font-semibold text-gray-600 mr-2">Class:</label>

                                <input type="text" [(ngModel)]="det.class" (change)="redraw()"
                                    [disabled]="!!det['ignore']" list="classOptions"
                                    class="block w-32 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm py-1.5 bg-white px-2">

                                <datalist id="classOptions">
                                    <option *ngFor="let name of classNames" [value]="name"></option>
                                </datalist>
                            </div>

                            <!-- Delete Button -->
                            <button (click)="deleteDetection(i)"
                                class="text-gray-400 hover:text-red-500 transition-colors" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>

                <p class="text-xs text-blue-500 mt-4 flex items-center">
                    <span class="mr-1">‚ÑπÔ∏è</span> Uncheck boxes to ignore incorrect detections. Correct classes if
                    needed. Then click Accept.
                </p>
            </div>

            <!-- Empty State -->
            <div *ngIf="prediction && prediction.detections.length === 0"
                class="bg-yellow-50 text-yellow-800 p-4 rounded-xl border border-yellow-200 text-center">
                No objects detected. You can reject this image or accept it as empty background.
            </div>

        </div>
    </div>

    <!-- Sticky Bottom Action Bar -->
    <div
        class="h-20 bg-white border-t border-gray-200 flex items-center justify-center space-x-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 flex-shrink-0">
        <button (click)="reject()"
            class="group flex flex-col items-center justify-center w-32 h-14 rounded-xl border-2 border-transparent bg-red-50 text-red-600 hover:bg-red-100 hover:border-red-200 active:scale-95 transition-all">
            <span class="font-bold">{{ mode === 'test' ? 'Skip' : 'Reject' }}</span>
        </button>

        <button (click)="accept()" [class.bg-blue-600]="mode === 'test'" [class.hover:bg-blue-700]="mode === 'test'"
            [class.bg-green-600]="mode === 'train'" [class.hover:bg-green-700]="mode === 'train'"
            class="group flex flex-col items-center justify-center w-48 h-14 rounded-xl shadow-lg text-white active:scale-95 transition-all">
            <span class="font-bold text-lg">{{ mode === 'test' ? 'Done' : 'Accept & Train' }}</span>
        </button>
    </div>

    <!-- Toast -->
    <div *ngIf="toastMessage"
        class="absolute top-24 left-1/2 transform -translate-x-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-full shadow-2xl flex items-center animate-fade-in-down z-50 backdrop-blur-sm border border-gray-700">
        <span class="text-green-400 mr-3 text-xl bg-green-500/20 rounded-full p-1">‚úì</span>
        {{ toastMessage }}
    </div>

</div>